<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>麻雀テスト</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
  <!-------common--------->
  <div id="yourKaze">
  <p>場風を選択してください。</p>
  </div>
  
 <!--//-----TOP画面---------->
 <div id="top">
    <div id="selectKaze">
  	<div id="ton" onClick="setup(0);">東</div>
  	<div id="nan" onClick="setup(1);">南</div>
  	<div id="sha" onClick="setup(2);">西</div>
  	<div id="pei" onClick="setup(3);">北</div>
  	<div id="stage" onClick="setup(4);">ステージ</div>
  </div>
</div>
<form id="game_start"></form>
<form id="doHaipai3"></form>
<form id="doHaipai4"></form>
<div id="startWaiting">
	<p id="joinNum">現在の参加人数：0人</p>
	<p>対局開始まで暫くお待ち下さい</p>
</div>
<!--------------プレイ画面----------------->
<div id="your_turn"></div>
<div id="tehai">
<div id="tehai_img1"></div>
<div id="tehai_img2"></div>
<span id="tehai_img3"></span>
<span id="tehai_img4"></span>
<span id="tehai_img5"></span>
<span id="tehai_img6"></span>
<span id="tehai_img7"></span>
<span id="tehai_img8"></span>
<span id="tehai_img9"></span>
<span id="tehai_img10"></span>
<span id="tehai_img11"></span>
<span id="tehai_img12"></span>
<span id="tehai_img13"></span>
<span id="tehai_img14"></span>
</div>
<div id="ton_sutehai">
<div id="ton_tenbou"> </div>
</div>
<div id="nan_sutehai"></div>
<div id="sha_sutehai"></div>
<div id="pei_sutehai"></div>
<div id="ton_nakihai"></div>
<div id="nan_nakihai"></div>
<div id="sha_nakihai"></div>
<div id="pei_nakihai"></div>
<div id="ton_reach"></div>
<div id="nan_reach"></div>
<div id="sha_reach"></div>
<div id="pei_reach"></div>
<div id="stage_monitor">
<div id="dora"></div>
<div id="nokori"></div>
<div id="now_stage"></div>
</div>

<div id="chi"></div>
<div id="pon"></div>
<div id="kan"></div>
<div id="ron"></div>
<div id="pass"></div>
<div id="reach"></div>
<audio id="aChi" src="./sound/chi.wav"></audio>
<audio id="aPon" src="./sound/pon.wav"></audio>
<audio id="aKan" src="./sound/kan.wav"></audio>
<audio id="aRon" src="./sound/ron.wav"></audio>
<audio id="aReach" src="./sound/reach.wav"></audio>
<audio id="aTsumo" src="./sound/tsumo.wav"></audio>
<audio id="aMaze" src="./sound/maze.wav"></audio>
<audio id="aSute" src="./sound/sute.wav"></audio>
<audio id="aReachBgm" src="./sound/reach_bgm.mp3"></audio>
<audio id="aBgm" src="./sound/bgm1.mp3" loop></audio>
<div id="yakuCulc">
<div id="yakuButton"></div>
</div>
<div id="game_end_monitor"></div>

<div id="1yaku"></div>
<div id="2yaku"></div>
<div id="3yaku"></div>
<div id="4yaku"></div>
<div id="5yaku"></div>
<div id="6yaku"></div>
<div id="7yaku"></div>
<div id="8yaku"></div>
<div id="9yaku"></div>
<div id="10yaku"></div>
<div id="11yaku"></div>
<div id="12yaku"></div>
<div id="13yaku"></div>

<div id="next_game"></div>

    <script src="//cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.js"></script>
    <script type="text/javascript" src="./select_pi.js"></script>
    <script type="text/javascript" src="./yaku.js"></script>
    <script>
//----------------------------javascript----------------------  
  var socket = io();
  var your_kaze=0;
  var now_turn=0;
  var myTehai = new Array(14);
  var myTehai_type = new Array(14);
  var points = [25000,25000,25000,25000];
  var temp_points = new Array(4);
//------------id name--------------
  var baName_en = ["ton","nan","sha","pei","stage"];
  var baName_ja = ["東","南","西","北","ステージ"];
  var now_stage_char = ["東一局" ,"東二局","東三局","東四局","南一局","南二局","南三局","南四局"];
  var naki_name = ["ton_nakihai" , "nan_nakihai" , "sha_nakihai","pei_nakihai"];
  var reach_name = ["ton_reach" , "nan_reach" , "sha_reach" , "pei_reach"];
  var bNaki =false;
  var bPon = false;
  var PLAYER_NUM = 3;
//   var oya=0;
  var pon_index1=0;
  var pon_index2=0;
  var bTrash = false;
//  var bReach = new Array(4);
  var reach_flag=0;
  var winner = 0;
  var winner_point = 0;
  var winner_point2 = 0;
  var bCanAction = new Array(6);
  var bRyukyoku = false;

  //--------------setup---------------------------
  function setup(data){
  	var data_char;
  	your_kaze=data;
  	socket.json.emit('setup',{
  		room:baName_en[data]
  	});
  	document.getElementById("selectKaze").innerHTML="<p></p>";
  	if(data!=4){//クライアント側
  		document.getElementById("yourKaze").innerHTML = "<p>あなたは"+baName_ja[data]+"家です。</p>";  		
		$('#startWaiting').css({
			'background' : 'none'
		});
		//bReach[data]=false;
		for(var i=0;i<bCanAction.length;i++){
			bCanAction[i] = false;
		}
  	}
  	if(data==4){//ステージ上
  		document.getElementById("doHaipai3").innerHTML+="<input type=\"submit\" value=\"配牌(3麻)\">";
  		document.getElementById("doHaipai4").innerHTML+="<input type=\"submit\" value=\"配牌(4麻)\">";
  		document.getElementById("tehai").innerHTML="";
   		$('#yourKaze').css({
  			'background-color':'#FF0',
  			'width' : '0'
  		});
 		document.getElementById('yourKaze').innerHTML = "";
 		for(var i=0;i<4;i++){
  			var temp = "#"+naki_name[i];
  			$(temp).css({
  				'border' : '1px solid #FF0'
  			});
  		}
  		document.getElementById("aBgm").play();
  	}
  	oya=0;
  }
  $('#doHaipai3').submit(function(e){
  	e.preventDefault();
  	stage_setHTML();
  	PLAYER_NUM = 3;
  	socket.emit('haipai' , 0);
  	console.log("3麻開始");
  });
  $('#doHaipai4').submit(function(e){
  	e.preventDefault();
  	stage_setHTML();
  	PLAYER_NUM = 4;
   	socket.emit('haipai' , 1);
  	console.log("4麻開始");
  });
  socket.on('stage_set',function(dora){
  	var temp = createPiAddr(dora);
  	document.getElementById("dora").innerHTML +="<p>ドラ<img src=\"./img/"+temp.addr+"\"></p>";
  	document.getElementById("nokori").innerHTML ="<p>残 69 牌</p>";
  	$('body').css({
  		'background-image' : "none",
  		'background-color':'#327D5D'
  	});
  });
  socket.on('stage_update',function(data){
  	document.getElementById("nokori").innerHTML = "<p>残 "+data+" 牌</p>";
  });
  function stage_setHTML(){
   	document.getElementById("doHaipai3").innerHTML = "";
   	document.getElementById("doHaipai4").innerHTML = "";
   	document.getElementById("ton_sutehai").innerHTML = "<p>東  "+points[0]+"</p>";
   	document.getElementById("nan_sutehai").innerHTML = "<p>南  "+points[1]+"</p>";
   	document.getElementById("sha_sutehai").innerHTML = "<p>西  "+points[2]+"</p>";
   	if(PLAYER_NUM==4)document.getElementById("pei_sutehai").innerHTML = "<p>北  "+points[3]+"</p>";
   	document.getElementById("startWaiting").innerHTML = "";
   	for(var i=0;i<4;i++){
   		$(sute_index2[i]).css({
   			'border':'3px solid #F00'
   		});
   	}
   	document.getElementById("game_start").innerHTML = "<input type=\"submit\" value=\"対局開始\">";
   	document.getElementById("aMaze").play();
   	
  } 
  var now_stage = 0;
  $('#game_start').submit(function(e){
  	e.preventDefault();
  	socket.emit('start' , 0);  	
  	console.log("PLAYER"+PLAYER_NUM);
  	document.getElementById("game_start").innerHTML = "";
  	document.getElementById("now_stage").innerHTML = "<p>"+now_stage_char[now_stage]+"</p>";
  });
  
  socket.on('notice_bakaze' , function(msg){
	document.getElementById("joinNum").innerHTML="<p id=\"joinNum\">現在の参加人数："+msg+"人</p>";
  });
 //-----------------------セットアップ終了---------------------------

  socket.on('tehai' , function(msg){
  	console.log("私は"+your_kaze+"家です。");
  	myTehai[0]=msg.tehai1;
  	myTehai[1]=msg.tehai2;
  	myTehai[2]=msg.tehai3;
  	myTehai[3]=msg.tehai4;
  	myTehai[4]=msg.tehai5;
  	myTehai[5]=msg.tehai6;
  	myTehai[6]=msg.tehai7;
  	myTehai[7]=msg.tehai8;
  	myTehai[8]=msg.tehai9;
  	myTehai[9]=msg.tehai10;
  	myTehai[10]=msg.tehai11;
  	myTehai[11]=msg.tehai12;
  	myTehai[12]=msg.tehai13;  
  	/*---------------------
  	0-35:マンズ 36-71:ピンズ 72-107:ソーズ 108-135:字牌
  	0~3:1 4~7: 2  8~11:3  12~15:4  16~19:5
  	36-39:_1 40-43:_2 44-47:_3 48-51:_4 52-55:_5 56
  	---------------------*/
  	document.getElementById("startWaiting").innerHTML = "";
  	document.getElementById("chi").innerHTML ="<p onClick=\"emitAction(0);\">チー</p>";
  	document.getElementById("pon").innerHTML = "<p onClick=\"emitAction(1)\">ポン</p>";
  	document.getElementById("kan").innerHTML = "<p onClick=\"emitAction(2);\">カン</p>";
  	document.getElementById("ron").innerHTML = "<p onClick=\"emitAction(3);\">ロン</p>";
  	document.getElementById("pass").innerHTML = "<p onClick=\"emitAction(4);\">パス</p>";
  	document.getElementById("reach").innerHTML = "<p onClick=\"emitAction(5);\">リーチ</p>";
  	if(your_kaze!=4)document.getElementById("yourKaze").innerHTML = "<p>あなたは"+baName_ja[your_kaze]+"家です。</p>"; 	
	fadeOutButton();
	for(var i=0;i<6;i++){
		$(ponChiArray[i]).css({
			'background-color':'#F00'
		});
	}
	myTehai = sortPi(myTehai);
  });
  
  //--------------ツモ--------------------------
  socket.on('tsumo' , function(data){
  	console.log("あなたのツモ牌です。"+data);
  	document.getElementById("your_turn").innerHTML += "<p>あなたの番です</p>";
  	if(reach_flag>0)document.getElementById("your_turn").innerHTML +="<p>リーチ！</p>";
  	var now_pi = createPiAddr(data);
  	myTehai[13] = data;
  	document.getElementById("tehai_img14").innerHTML += "<img  style=\"margin-left:30px;\" src=\"./img/"+now_pi.addr+"\" onClick=\"selectPi(14);\">";
  	bTrash = true;
  	if(reach_flag==1)reach_flag=2;

  });

  //-----------チー・ポン・カン・ロン----------
  var ponChiArray = ["#chi","#pon","#kan","#ron","#pass","#reach"];
  function emitAction(n){
  	switch(n){
  		case 0:
  			if(bCanAction[0]){
  				document.getElementById("your_turn").innerHTML += "<p>ペアにする牌を２つ選択してください。</p>";
	  			bSelectPair=true;
  				bNaki=true;
  				socket.emit('now_turn',your_kaze);
  				fadeOutButton();
  			}
  			break;
  		case 1:
			if(bCanAction[1]){
				console.log("PON!"+pon_index1+":"+pon_index2);
				var temp1 = myTehai[pon_index1];
				var temp2 = myTehai[pon_index2];
				myTehai[pon_index1]=0;
				myTehai[pon_index2]=0;
				myTehai = sortPi(myTehai);
				socket.emit('pon',{
					kaze:now_turn,
					naki_player:your_kaze,
					pi1 : temp1,
					pi2 : temp2,
					tehai : myTehai
				});
				fadeOutButton();
				audioPon.play();
				bTrash=true;
  			}
  			break;
  		case 2:
  			socket.emit('kan' , your_kaze);
  			break;
  		case 3:
  			for(var i=0;i<4;i++){
  				temp_points[i]=points[i];
  			}
  			socket.emit('ron',{
  				kaze : your_kaze,
  				tehai : myTehai,
  				now_points : points
  			});
  			winner = your_kaze;
  			console.log("ロン！"+your_kaze);
  			if(now_turn==your_kaze)document.getElementById("aTsumo").play();
  			else document.getElementById("aRon").play();
  			break;
  		case 4:
  			if(bCanAction[4]){
	  			socket.emit('pass' , your_kaze);
	  			fadeOutButton();
  			}
  			break;
  		case 5:
  			if(bCanAction[5]){
  				reach_flag = 1;
  				document.getElementById("your_turn").innerHTML += "<p>リーチ！	</p>";
  				banAction(5);
  			}
  			break;
  	}
  }
  function fadeOutButton(){
  	for(var i=0;i<6;i++){
	  	$(ponChiArray[i]).css({
  			'opacity':'0.3'
  		});
  	}
  }
  socket.on('sutehai_data',function(data){
  	var now_sutehai = createPiAddr(data);
  	var pon_count=0;
  	pon_index1=0;
  	pon_index2=0;
  	
  	console.log("tehai_length:"+tehai_length);
  	//--------------ポンできるかチェック---------------
  	for(var i=0;i<tehai_length;i++){
  		var temp = createPiAddr(myTehai[i]);
  		if(now_sutehai.id==temp.id){
  			pon_count++;
  			if(pon_index1==0)pon_index1=i;
  			else if(pon_index2==0)pon_index2=i;
  		}
  		console.log("poncheck:"+now_sutehai.id+":"+temp.id);
  	}
  	if(pon_count>1){//ポン可能にする
  	  	console.log("youcanpon");
  		//bPon=true;
  		bCanAction[1] = true;
  		$('#pon').css({
  			'opacity':'1.0'
  		});
  	}
  });
  
  //---------------チー-----------------------
  socket.on('naki',function(data){//ステージ上
  	socket.emit('clearClientNotice',now_turn);
	console.log(data.get_pi+":"+data.selected_pi1+":"+data.selected_pi2+":"+data.pi[0]);

  	var temp = new Array(3);
  	temp[0] = createPiAddr(data.get_pi);
  	temp[1] = createPiAddr(data.selected_pi1);
  	temp[2] = createPiAddr(data.selected_pi2);
  	$(sute_index2[now_turn]).empty();
  	document.getElementById(sute_index[now_turn]).innerHTML = "<p>"+ baName[now_turn]+"  "+points[0]+"</p>";
  	for(var i=0;i<data.index;i++){
  		var temp2 = createPiAddr(data.pi[i]);
  		console.log("捨て牌:"+i+":"+temp2.id);
  		document.getElementById(sute_index[now_turn]).innerHTML +="<img src=\"./img/"+temp2.addr+"\">";
  	}
  	now_turn = data.player;
  	for(var i=0;i<3;i++){
  		document.getElementById(naki_name[data.player]).innerHTML +="<img src=\"./img/"+temp[i].addr+"\">";
  	}
  });
  //--------------リーチ--------------------
  socket.on('reach',function(data){//ステージ上
  	console.log("リーチ!"+data);
  	
  	document.getElementById(reach_name[data]).innerHTML = "<img src=\"./img/tenbou2.png\">";
	document.getElementById("aReach").play();
	setTimeout(function(){
		document.getElementById("aReachBgm").play();	
	},500);
	document.getElementById("aBgm").pause();
	//document.getElementById("aBgm").seekable.start();

  });
    
  socket.on('canAction' , function(data){
	canAction(data);
  });
    socket.on('banAction',function(data){
	banAction(data);
  });
  function canAction(b){
  	$(ponChiArray[b]).css({
  		'opacity' : '1.0'
  	});
  	bCanAction[b] = true;
  }
  function banAction(b){
  	$(ponChiArray[b]).css({
  		'opacity' : '0.3'
  	});
  	bCanAction[b] = false;
  }
    
  //---------------捨て牌処理-------------------
  var sute_index = ["ton_sutehai","nan_sutehai","sha_sutehai","pei_sutehai"];
  var sute_index2 = ["#ton_sutehai" , "#nan_sutehai" , "#sha_sutehai" , "#pei_sutehai"];
  socket.on('sutehai' , function(data){
  	var pai = createPiAddr(data.index);
  	console.log("sutehai:"+pai.addr);
  	document.getElementById(sute_index[data.player]).innerHTML += "<img src=\"./img/"+pai.addr+"\">";
  	document.getElementById("aSute").play();
  });
  
  socket.on('turn_end',function(data){
  	document.getElementById("your_turn").innerHTML = "";
  	console.log("turn_end");
  });
  var bSelectPair = false;
  var nSelectPair = 0;
  socket.on('your_turn',function(data){
  	document.getElementById("your_turn").innerHTML = "<p>あなたの番です</p>";
  	now_turn = your_kaze;
  });
  socket.on('clearClientNotice',function(data){
  	console.log("receive clearClientNotice");
  	document.getElementById("your_turn").innerHTML = "";
  });

//------------------ゲーム終了処理------------------------
  socket.on('game_end',function(data){
  	game_end(data.kaze , data.tehai , data.ron_pi , data.reach , data.uraDora , data.dora);
  	for(var i=0;i<4;i++){
  		temp_points[i] = data.now_points[i];
  	}
  });
  function game_end(kaze , tehai , ron_pi , bReach , ura , dora){
  	winner = kaze;
  	if(your_kaze<4){
  		console.log("now_mykaze:"+your_kaze);
  		your_kaze++;
  		if(your_kaze>=PLAYER_NUM)your_kaze=0;
  		console.log("now_mykaze2:"+your_kaze);
  		for(var i=1;i<=14;i++){
  			document.getElementById("tehai_img"+i).innerHTML = "";
 	 	}
 	 	document.getElementById("your_turn").innerHTML = "<p>ゲーム終了</p>";
 	 	if(kaze==5)document.getElementById("your_turn").innerHTML += "<p>流局</p>"
  		fadeOutButton();
  	}
  	if(your_kaze==4){//ステージ用
  		if(kaze==5)document.getElementById("your_turn").innerHTML = "<p>流局</p>";
  		//--------画面初期化-------------
  		for(var i=0;i<4;i++){
	  		document.getElementById(sute_index[i]).innerHTML = "";
	  		document.getElementById(naki_name[i]).innerHTML = "";
	  		$(sute_index2[i]).css({
	  			'border-style':'none'
	  		});
	  		var temp = "#"+naki_name[i];
	  		$(temp).css({
	  			'border-style' : 'none',
	  			'width' : '0'
	  		});
	  		var temp2 = "#"+reach_name[i];
   			$(temp2).empty();
	  	}
	  	$('#startWaiting').css({
   			'background' : 'none'
   		});
   		$('#nokori').empty();
   		$('#now_stage').empty();
	  	document.getElementById("dora").innerHTML = "";
	  	//---------画面初期化ここまで-----------
	  
	  	//----------------あがり手牌など画面表示-----------------
	  	document.getElementById("game_end_monitor").innerHTML = "<p>"+baName_ja[kaze]+"家がロンしました</p>";
	  	for(var i=1;i<14;i++){
	  		var temp = createPiAddr(tehai[i-1]);
	  		document.getElementById("game_end_monitor").innerHTML += "<img src=\"./img/"+temp.addr+"\">";
	  		console.log("ロン手牌:"+i+":"+temp.id+":"+tehai[i]);
	  	}
	  	var temp_pi = createPiAddr(ron_pi);
	  	var temp_dora = createPiAddr(dora);
	  	var temp_ura = createPiAddr(ura);
	  	console.log(bReach);
	  	if(!bReach)document.getElementById("game_end_monitor").innerHTML +="<p>あがり牌 <img src=\"./img/"+temp_pi.addr+"\"> ドラ<img src=\"./img/"+temp_dora.addr+"\"></p>";
	  	else document.getElementById("game_end_monitor").innerHTML +="<p>あがり牌 <img src=\"./img/"+temp_pi.addr+"\">　ドラ<img src=\"./img/"+temp_dora.addr+"\">　裏ドラ<img src=\"./img/"+temp_ura.addr+"\"></p>";

	  	$('#game_end_monitor').css({
	  		'height' : '650px',
	  		'width' : '800px'
	  	});
	  	$('#game_end_monitor > img').css({
	  		'width' : '50px'
	  	});
	 
	  	for(var i=1;i<14;i++){
	  		document.getElementById(i+"yaku").innerHTML += "<div onClick=\"doCulc("+i+");\">"+yaku_point[i-1]+"</div>";
	  		var temp = "#"+i+"yaku";
	  		$(temp).css({
	  			'width': '120px',
	  			'height' : '45px',
	  			'font-size' : '20px',
	  			'text-align' : 'center',
	  			'line-height' : '45px',
	  			'border' : '1px solid #0F0',
	  			'margin' : '5px',
	  			'background-color' : '#F55',
	  			'position' : 'static',
	  			'z-index' : '5'
	  		});
	  	}
		document.getElementById("next_game").innerHTML = "<div onClick=\"next_game();\">次の対局へ</div>";
		$('#next_game').css({
			'background-color':'#F00',
			'line-height' : '100px'
		});
		
  	}
  }
  
  socket.on('ryukyoku' , function(data){
  	bRyukyoku = true;
  	game_end(5);
  	
  });
  
  //------------------次局の準備-----------------
  function next_game(){//ステージ上
  	//---------------画面初期化------------------
  	$('#game_end_monitor').empty();
  	//-------------------------------------------
  	now_stage++;
  	document.getElementById("now_stage").innerHTML ="<p>"+now_stage_char[now_stage]+"</p>";
  	document.getElementById("yakuButton").innerHTML = "";
  	now_turn=0;
  	socket.emit('next_game',now_stage);
  	bNaki=false;
  	bSelectPair = false;
  	socket.emit('haipai',PLAYER_NUM-3);
  	var n = Math.floor(Math.random()*PLAYER_NUM);
  	socket.emit('start',n);
  	if(oya<PLAYER_NUM-1)oya++;
  	else oya=0;
  	
  	document.getElementById("ton_sutehai").innerHTML = "<p>東  "+points[0]+"</p>";
   	document.getElementById("nan_sutehai").innerHTML = "<p>南  "+points[1]+"</p>";
   	document.getElementById("sha_sutehai").innerHTML = "<p>西  "+points[2]+"</p>";
   	if(PLAYER_NUM==4)document.getElementById("pei_sutehai").innerHTML = "<p>北  "+points[3]+"</p>";
   	for(var i=0;i<4;i++){
   		$(sute_index2[i]).css({
   			'border':'3px solid #F00'
   		});
   		var temp = "#" + naki_name[i];
   		$(temp).css({
   			'border' : '1px solid #FF0',
   			'width' : '600px'
   		});
//    		var temp2 = "#"+reach_name[i];
//    		$(temp2).empty();
   	}
   	for(var i=1;i<14;i++){
   		var temp = "#"+i+"yaku";
   		$(temp).css({
   			'border-style' : 'none',
   			'background' : 'none',
   			'width' : '0',
   			'height' : '0'
   		});
   	}
   	$('#game_end_monitor').css({
   		'height' : '0',
   		'width' : '0'
   	});
   	$('#next_game').empty();
   	$('#dora').empty();
   	$('#next_game').css({
   		'background-color':'transparent'
   	});
   	for(var i=1;i<14;i++){
	  	document.getElementById(i+"yaku").innerHTML = "";
	 }
   	
  }
  socket.on('resetClient',function(data){//プレイヤー側
  	if(your_kaze!=4){
  		document.getElementById("your_turn").innerHTML = "";
  		for(var i=1;i<=14;i++){
  			document.getElementById("tehai_img"+i).innerHTML = "";
  		}
  		reach_flag=0;
  	}
  });
  //----------------その他処理------------------
  socket.on('now_turn',function(data){
  	now_turn = data;
  });

  
</script>
  </body>
</html>