<!doctype html>
<html>
  <head>
    <title>麻雀テスト</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
  <!-------common--------->
  <div id="yourKaze">
  <p>場風を選択してください。</p>
  </div>
  
 <!--//-----TOP画面---------->
 <div id="top">
    <div id="selectKaze">
  	<div id="ton" onClick="setup(0);">東</div>
  	<div id="nan" onClick="setup(1);">南</div>
  	<div id="sha" onClick="setup(2);">西</div>
  	<div id="pei" onClick="setup(3);">北</div>
  	<div id="stage" onClick="setup(4);">ステージ</div>
  </div>
</div>
<form id="game_start"></form>
<form id="doHaipai3"></form>
<form id="doHaipai4"></form>
<div id="startWaiting">
	<p id="joinNum">現在の参加人数：0人</p>
	<p>対局開始まで暫くお待ち下さい</p>
</div>
<!--------------プレイ画面----------------->
<div id="your_turn"></div>
<div id="tehai">
<div id="tehai_img1"></div>
<div id="tehai_img2"></div>
<span id="tehai_img3"></span>
<span id="tehai_img4"></span>
<span id="tehai_img5"></span>
<span id="tehai_img6"></span>
<span id="tehai_img7"></span>
<span id="tehai_img8"></span>
<span id="tehai_img9"></span>
<span id="tehai_img10"></span>
<span id="tehai_img11"></span>
<span id="tehai_img12"></span>
<span id="tehai_img13"></span>
<span id="tehai_img14"></span>
</div>
<div id="ton_sutehai"></div>
<div id="nan_sutehai"></div>
<div id="sha_sutehai"></div>
<div id="pei_sutehai"></div>
<div id="ton_nakihai"></div>
<div id="nan_nakihai"></div>
<div id="sha_nakihai"></div>
<div id="pei_nakihai"></div>
<div id="stage_monitor">
<div id="dora"></div>
<div id="nokori"></div>
<div id="now_stage"></div>
</div>

<div id="chi"></div>
<div id="pon"></div>
<div id="kan"></div>
<div id="ron"></div>
<div id="pass"></div>
<div id="reach"></div>

<div id="yakuCulc">
<div id="yakuButton"></div>
</div>

<div id="next_game"></div>

    <script src="//cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.js"></script>
    <script type="text/javascript" src="./select_pi.js"></script>
    <script>
//----------------------------javascript----------------------  
  var socket = io();
  var your_kaze=0;
  var now_turn=0;
  var baName_en = ["ton","nan","sha","pei","stage"];
  var baName_ja = ["東","南","西","北","ステージ"];
  var bNaki =false;
  var bPon = false;
  var now_stage_char = ["東一局" ,"東二局","東三局","東四局","南一局","南二局","南三局","南四局"];
  var naki_name = ["ton_nakihai" , "nan_nakihai" , "sha_nakihai","pei_nakihai"];
  var PLAYER_NUM = 3;
  var oya=0;
  var ton_sutehai = new Array(30);
  var nan_sutehai = new Array(30);
  var sha_sutehai = new Array(30);
  var pei_sutehai = new Array(30);
  var ton_sutehai_index=0;
  var nan_sutehai_index=0;
  var sha_sutehai_index=0;
  var pei_sutehai_index=0;
  var pon_index1=0;
  var pon_index2=0;

  //--------------setup---------------------------
  function setup(data){
  	var data_char;
  	your_kaze=data;
  	socket.json.emit('setup',{
  		room:baName_en[data]
  	});
  	document.getElementById("selectKaze").innerHTML="<p></p>";
  	if(data!=4){
  		document.getElementById("yourKaze").innerHTML = "<p>あなたは"+baName_ja[data]+"家です。</p>";
  	}
  	if(data==4){
  		document.getElementById("doHaipai3").innerHTML+="<input type=\"submit\" value=\"配牌(3麻)\">";
  		document.getElementById("doHaipai4").innerHTML+="<input type=\"submit\" value=\"配牌(4麻)\">";
  		document.getElementById("tehai").innerHTML="";
   		$('#yourKaze').css({
  			'background-color':'#FF0',
  			'width' : '0'
  		});
 		document.getElementById('yourKaze').innerHTML = "";
  	}
  }
  $('#doHaipai3').submit(function(e){
  	e.preventDefault();
  	stage_setHTML();
  	PLAYER_NUM = 3;
  	socket.emit('haipai' , 0);
  	console.log("3麻開始");
  });
  $('#doHaipai4').submit(function(e){
  	e.preventDefault();
  	stage_setHTML();
  	PLAYER_NUM = 4;
   	socket.emit('haipai' , 1);
  	console.log("4麻開始");
  });
  socket.on('stage_set',function(dora){
  	var temp = createPiAddr(dora);
  	document.getElementById("dora").innerHTML +="<p>ドラ<img src=\"./img/"+temp.addr+"\"></p>";
  	document.getElementById("nokori").innerHTML ="<p>残 69 牌</p>";
  	$('body').css({
  		'background-image' : "none",
  		'background-color':'#327D5D'
  	});
  });
  socket.on('stage_update',function(data){
  	document.getElementById("nokori").innerHTML = "<p>残 "+data+" 牌</p>";
  });
  function stage_setHTML(){
   	document.getElementById("doHaipai3").innerHTML = "";
   	document.getElementById("doHaipai4").innerHTML = "";
   	document.getElementById("ton_sutehai").innerHTML = "<p>東</p>";
   	document.getElementById("nan_sutehai").innerHTML = "<p>南</p>";
   	document.getElementById("sha_sutehai").innerHTML = "<p>西</p>";
   	document.getElementById("pei_sutehai").innerHTML = "<p>北</p>";
   	document.getElementById("startWaiting").innerHTML = "";
   	for(var i=0;i<4;i++){
   		$(sute_index2[i]).css({
   			'border':'3px solid #F00'
   		});
   	}
   	document.getElementById("game_start").innerHTML = "<input type=\"submit\" value=\"対局開始\">";
  }  
  var now_stage = 0;
  $('#game_start').submit(function(e){
  	e.preventDefault();
  	socket.emit('start' , 0);  	
  	console.log("PLAYER"+PLAYER_NUM);
  	document.getElementById("game_start").innerHTML = "";
  	document.getElementById("now_stage").innerHTML = "<p>"+now_stage_char[now_stage]+"</p>";
  });
  
  socket.on('notice_bakaze' , function(msg){
	document.getElementById("joinNum").innerHTML="<p id=\"joinNum\">現在の参加人数："+msg+"人</p>";
  });
 
  var myTehai = new Array(14);
  var myTehai_type = new Array(14);
  socket.on('tehai' , function(msg){
  	console.log("私は"+your_kaze+"家です。");
  	myTehai[0]=msg.tehai1;
  	myTehai[1]=msg.tehai2;
  	myTehai[2]=msg.tehai3;
  	myTehai[3]=msg.tehai4;
  	myTehai[4]=msg.tehai5;
  	myTehai[5]=msg.tehai6;
  	myTehai[6]=msg.tehai7;
  	myTehai[7]=msg.tehai8;
  	myTehai[8]=msg.tehai9;
  	myTehai[9]=msg.tehai10;
  	myTehai[10]=msg.tehai11;
  	myTehai[11]=msg.tehai12;
  	myTehai[12]=msg.tehai13;  
  	/*---------------------
  	0-35:マンズ 36-71:ピンズ 72-107:ソーズ 108-135:字牌
  	0~3:1 4~7: 2  8~11:3  12~15:4  16~19:5
  	36-39:_1 40-43:_2 44-47:_3 48-51:_4 52-55:_5 56
  	---------------------*/
  	document.getElementById("startWaiting").innerHTML = "";
  	document.getElementById("chi").innerHTML ="<p onClick=\"emitAction(0);\">チー</p>";
  	document.getElementById("pon").innerHTML = "<p onClick=\"emitAction(1)\">ポン</p>";
  	document.getElementById("kan").innerHTML = "<p onClick=\"emitAction(2);\">カン</p>";
  	document.getElementById("ron").innerHTML = "<p onClick=\"emitAction(3);\">ロン</p>";
  	document.getElementById("pass").innerHTML = "<p onClick=\"emitAction(4);\">パス</p>";
  	document.getElementById("reach").innerHTML = "<p onClick=\"emitAction(5);\">リーチ</p>";
  	if(your_kaze!=4)document.getElementById("yourKaze").innerHTML = "<p>あなたは"+baName_ja[your_kaze]+"家です。</p>"; 	
	fadeOutButton();
	for(var i=0;i<6;i++){
		$(ponChiArray[i]).css({
			'background-color':'#F00'
		});
	}
	myTehai = sortPi(myTehai);
  });
  
  //--------------ツモ--------------------------
  var bTrash = false;
  socket.on('tsumo' , function(data){
  	console.log("あなたのツモ牌です。"+data);
  	document.getElementById("your_turn").innerHTML += "<p>あなたの番です</p>";
  	var now_pi = createPiAddr(data);
  	myTehai[13] = data;
  	document.getElementById("tehai_img14").innerHTML += "<img src=\"./img/"+now_pi.addr+"\" onClick=\"selectPi(14,"+data+")\">";
  	bTrash = true;
  });
  socket.on('now_turn',function(data){
  	now_turn = data;
	fadeOutButton();
  });
  //-----------チー・ポン・カン・ロン----------
  var ponChiArray = ["#chi","#pon","#kan","#ron","#pass","#reach"];
  function emitAction(n){
  	switch(n){
  		case 0:
  			document.getElementById("your_turn").innerHTML += "<p>ペアにする牌を２つ選択してください。</p>";
	  		bSelectPair=true;
  			bNaki=true;
  			socket.emit('now_turn',your_kaze);
  			break;
  		case 1:
			if(bPon){
				socket.emit('pon',{
					kaze:now_turn,
					naki_player:your_kaze,
				});
				console.log("PON!"+pon_index1+":"+pon_index2);
				myTehai[pon_index1]=0;
				myTehai[pon_index2]=0;
				myTehai = sortPi(myTehai);
  				socket.emit('pon' , your_kaze);
				bPon=false;
  			}
  			break;
  		case 2:
  			socket.emit('kan' , your_kaze);
  			break;
  		case 3:
  			socket.emit('ron' , your_kaze);
  			break;
  		case 4:
  			socket.emit('pass' , your_kaze);
  			break;
  		case 5:
  			socket.emit('reach' , your_kaze);
  			break;
  	}
  		fadeOutButton();
  }
  function fadeOutButton(){
  	for(var i=0;i<6;i++){
	  	$(ponChiArray[i]).css({
  			'opacity':'0.3'
  		});
  	}
  }
  socket.on('sutehai_data',function(data){
  	var now_sutehai = createPiAddr(data);
  	var pon_count=0;
  	pon_index1=0;
  	pon_index2=0;

  	
  	console.log("tehai_length:"+tehai_length);
  	//--------------ポンできるかチェック---------------
  	for(var i=0;i<tehai_length;i++){
  		var temp = createPiAddr(myTehai[i]);
  		if(now_sutehai.id==temp.id){
  			pon_count++;
  			if(pon_index1==0)pon_index1=i;
  			else if(pon_index2==0)pon_index2=i;
  		}
  		console.log("poncheck:"+now_sutehai.id+":"+temp.id);
  	}
  	if(pon_count>1){//ポン可能にする
  	  	console.log("youcanpon");
  		bPon=true;
  		$('#pon').css({
  			'opacity':'1.0'
  		});
  	}
  });
  
  //---------------チー-----------------------
  socket.on('chi',function(data){//ステージ上
  	socket.emit('clearClientNotice',now_turn);
  	console.log("now_turn"+now_turn);
  	now_turn=data.player;
  	console.log("chi_player:"+now_turn);
	console.log(data.get_pi+":"+data.selected_pi1+":"+data.selected_pi2);
  	if(data.pi[0]==0){
  		console.log("chi!!!:"+data.pi[0]+":"+now_turn);
  		document.getElementById(sute_index[now_turn]).innerHTML = "";
  	}
  	var index=0;
  	var temp = new Array(3);
  	temp[0] = createPiAddr(data.get_pi);
  	temp[1] = createPiAddr(data.selected_pi1);
  	temp[2] = createPiAddr(data.selected_pi2);
  	while(data.pi[index]!=0){
  		var temp2 = createPiAddr(data.pi[index]);
  		document.getElementById(sute_index[now_turn]).innerHTML +="<img src=\"./img/"+temp2.addr+"\">";
  	}
  	for(var i=0;i<3;i++){
  		document.getElementById(naki_name[data.player]).innerHTML +="<img src=\"./img/"+temp[i].addr+"\">";
  	}
  });
    
  socket.on('canAction' , function(data){
  	$(ponChiArray[data]).css({
  		'opacity' : '1.0'
  	});
  });
    
  //---------------捨て牌処理-------------------
  var sute_index = ["ton_sutehai","nan_sutehai","sha_sutehai","pei_sutehai"];
  var sute_index2 = ["#ton_sutehai" , "#nan_sutehai" , "#sha_sutehai" , "#pei_sutehai"];
  socket.on('sutehai' , function(data){
  	var pai = createPiAddr(data.index);
  	console.log("sutehai:"+pai.addr);
  	document.getElementById(sute_index[data.player]).innerHTML += "<img src=\"./img/"+pai.addr+"\">";
  });
  
  socket.on('turn_end',function(data){
  	document.getElementById("your_turn").innerHTML = "";
  	console.log("turn_end");
  });
  var bSelectPair = false;
  var nSelectPair = 0;
  socket.on('your_turn',function(data){
  	document.getElementById("your_turn").innerHTML = "<p>あなたの番です</p>";
  	if(data==1){
//  		document.getElementById("your_turn").innerHTML += "<p>ペアにする牌を２つ選択してください。</p>";
  //		bSelectPair=true;
  	}
  	now_turn = your_kaze;
  });
  socket.on('clearClientNotice',function(data){
  	console.log("receive clearClientNotice");
  	document.getElementById("your_turn").innerHTML = "";
  });
  //------------------------ゲーム終了処理------------------------
  var yaku_name=["平和","断ヤオ","イーペーコー","チャンタ","一気通貫","三色同順","三色同刻","トイトイ","三暗刻","三槓子","小三元","七対子","二盃口","ジュンチャン","ホンイツ","チンイツ","役満系"];
  socket.on('game_end',function(data){
  	if(your_kaze<4){
  		console.log("PLAYER_NUM:"+PLAYER_NUM);
  		console.log("now_mykaze:"+your_kaze);
  		your_kaze++;
  		if(your_kaze>=PLAYER_NUM)your_kaze=0;
  		console.log("now_mykaze2:"+your_kaze);
  		for(var i=1;i<=14;i++){
  			document.getElementById("tehai_img"+i).innerHTML = "";
 	 	}
 	 	document.getElementById("your_turn").innerHTML = "<p>ゲーム終了</p>";
  		fadeOutButton();
  	}
  	if(your_kaze==4){//ステージ用
  		ton_sutehai_index=0;
  		nan_sutehai_index=0;
  		sha_sutehai_index=0;
  		pei_sutehai_index=0;
  		for(var i=0;i<4;i++){
	  		document.getElementById(sute_index[i]).innerHTML = "";
	  		$(sute_index2[i]).css({
	  			'border-style':'none'
	  		});
	  	}
	  	document.getElementById("dora").innerHTML = "";
	  	for(var i=0;i<yaku_name.length;i++){
		  	document.getElementById("yakuButton").innerHTML += "<div>"+yaku_name[i]+"</div>";
		  }
		document.getElementById("next_game").innerHTML = "<div onClick=\"next_game();\">次の対局へ</div>";
		$('#next_game').css({
			'background-color':'#F00'
		});
  	}
  });
  
  //------------次の対局-----------------
  function next_game(){//ステージ上
  	now_stage++;
  	document.getElementById("now_stage").innerHTML ="<p>"+now_stage_char[now_stage]+"</p>";
  	document.getElementById("yakuButton").innerHTML = "";
  	now_turn=0;
  	socket.emit('next_game',now_stage);
  	bNaki=false;
  	bSelectPair = false;
  	socket.emit('haipai',PLAYER_NUM-3);
  	var n = Math.floor(Math.random()*PLAYER_NUM);
  	socket.emit('start',n);
  	
  }
  
  socket.on('resetClient',function(data){//プレイヤー側
  	if(your_kaze!=4){
  		document.getElementById("your_turn").innerHTML = "";
  		for(var i=1;i<=14;i++){
  			document.getElementById("tehai_img"+i).innerHTML = "";
  		}
  	}
  });
  
</script>
  </body>
</html>